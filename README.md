# 基于OpenWRT在Azure上搭建VPN站点实现科学上网全记录

本文将围绕OpenWRT，通过在Azure上的VM，与家里的路由器建立VPN隧道，从而实现自动路由，国内国外访问分离。以及不在家时通过移动端，手机或笔记本电脑与家里建立VPN连接实现网络互联互通的目标。  

我将尽量详细的说明和记录各个环节和可能会遇到的坑和解决方法。但也需要你具备以下IT方面的基础知识。  
1. Linux系统基础知识
2. 虚拟机
3. 网络基础知识，包括TCP/IP协议，DNS，路由，防火墙等基础知识。 

## 目标
1. 家里网络实现国内国外访问路由分离，使国内访问走国内路由，国外访问走特定线路以实现网络访问的速度和相应最优化。
2. 手机端同样利用已建立的VPN实现访问优化
3. 实现DNS分流，优化DNS解析，实现安全、无污染的DNS解析

## 目录

- 整体网络设计和架构
- 为何选择IPSEC协议？
- 创建Azure VM
  - VHD虚拟磁盘制作
  - Azure VM新建
- OpenWRT基本设置，应用安装
- Strongswan设置
- mosdns设置

## 整体网络设计和架构
![Network Diagram](https://github.com/user-attachments/assets/35adae3f-1dcc-4fbd-a234-da9bd80d76cf)

### 主路由
1. 主要功能：
- 连接到互联网；
- 提供DHCP服务；
- 端口映射；将内网的地址和端口映射到外网端口上，实现对外服务。比如在外用手机客户端连回家里。
- 静态路由；
- 提供Wifi无线网络；
- 提供默认DNS服务；
2. 主路由的角色：  
作为基础上网路由器，在没有旁路由的情况下也不影响日常的上网，可以通过更改DHCP设置来控制局域网内的设备是直接走主路由上网还是走旁路由上网。  
主路由连接Internet，重点是：**需要ISP提供公网IP地址**，后面会用到DDNS来绑定域名。 如果没有公网IP地址，可以打客服电话让ISP开通公网IP，一般都可以。 
3. 关于DDNS，域名和证书:  
IPSEC IKEV2通过手机端连接到家里的网络会需要证书验证，所以会用到免费域名。（当然你也可以用付费的域名，本文不讨论付费域名。）  
虽然有很多免费的域名可以选择申请使用，但我们要选择在国内没有被限制访问的，不翻墙能正常打开网页的。  
有了公网地址，有了域名，最后就需要SSL证书。
我们使用ACME来自动获得免费的Let's Encrypt的证书，由于国内屏蔽了80端口，所以只能用DNS Chanllenge的方式来验证你的域名的所有权。  
选择的DDNS必须是可以提供API来帮助第三方来验证你的域名。  
支持DNS Chanllenge的DDNS可以从下面链接里查看选择。  
https://community.letsencrypt.org/t/dns-providers-who-easily-integrate-with-lets-encrypt-dns-validation/86438
4. 为何需要公网IP地址？
